---
title: "Thematic Mapping"
output: html_notebook
---

from:  https://www.computerworld.com/article/3175623/data-analytics/mapping-in-r-just-got-a-whole-lot-easier.html


```{r}
library(tidyverse)       # Tidyverse for Tidy Data
library(readxl)
library(tmap)            # Thematic Mapping
library(tmaptools) 
library(tigris)          # Get Census Geography Poloygons
library(htmlwidgets)     # To Save map as an interactive HTML widget
library(leaflet)         
library(sf)
```


# Get Shapfiles in a "simple features format"

```{r}
us_geo <- states(class = "sf")
# us_geo_spdf <- states()  # spdf uses @data slots -- old school
```

# Structure of a sf file

```{r}
class(us_geo)
glimpse(us_geo)
```

## Look at the Tibble
```{r}
as_tibble(us_geo)
```

## Get BLS Data

https://data.bls.gov/oes/#/occGeo/One%20occupation%20for%20multiple%20geographical%20areas

-  One occupation for multiple geographical areas

    - Mental Health and Substance Abuse Social Workers
    
        - State
        
        - All States in this list
        
        - Annual Mean wage
        
            - Excel
            
- Read the Data in with the readr data wizard

```{r}
# Skip first four lines
# Make second column numeric

Salary4Helpers <- 
  read_excel("~/R/github/mapping-with-R/data/OES_Report.xlsx", 
    col_types = c("text", "numeric"), skip = 4)

Salary4Helpers
```

        
        

# Wrangle the Data

```{r}
BlsWage_ToJoin <- Salary4Helpers %>% 
  rename(Area = "Area Name") %>% 
  rename(wages = "Annual mean wage(2)") %>% 
  mutate(State = gsub("\\(\\d{7}\\)", "", Area)) %>% 
  filter(wages != "NA_character_") %>% 
  select(State, wages)
BlsWage_ToJoin
```


## Append Data

Using the `append_data()` function of the `tmaptools` package, append BLS data to the previously loaded shape object

```{r}
HelperShapeObject <- append_data(us_geo, BlsWage_ToJoin, 
                                 key.shp = "NAME",
                                 key.data = "State")
as_tibble(HelperShapeObject)
```


## Quick Thematic Map

```{r}
qtm(HelperShapeObject, fill = "wages")
```

# The contiguous 48 states

```{r}
contiguous_states <- HelperShapeObject %>% 
  filter(REGION != 9) %>% 
  filter(STUSPS != "AK") %>% 
  filter(STUSPS != "HI")
  
```


## Make Choropleth

```{r}
tm_shape(contiguous_states) +
  tm_polygons("wages", id = "Name")
```


## Make Map Interactive
```{r}
tmap_mode("view")

```


```{r}
interactive_helpers <- tm_shape(contiguous_states) +
  tm_polygons("wages", id = "Name")
```


```{r}
interactive_helpers
```


```{r}

InteractiveHelpersMap <- tmap_leaflet(interactive_helpers)
saveWidget(InteractiveHelpersMap,
           "Substance-Abuse-Social-Worker_Median-Wage.html")
```



## Leaflet View of Same Map

```{r}

pal <- colorNumeric(palette = "Greens",
                               domain = contiguous_states$wages)

contiguous_states %>% 
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>%
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(fillOpacity = 0.7,
              smoothFactor = 0,
              stroke = FALSE, 
              color = ~pal(wages)) %>% 
  addLegend("bottomleft", 
              pal = pal, 
              values = ~ wages,
              bins = 5,
              title = "Librarian Median Wages",
              labFormat = labelFormat(prefix = "$"),
              opacity = 1)



```


